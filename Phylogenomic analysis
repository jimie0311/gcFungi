#Note: This pipeline is used for phylogenomic analysis based on BUSCO genes.
## Step 1: Detection of BUSCO genes
#Following the website https://busco.ezlab.org/ to install BUSCO v5 and dowload the BUSCO dataset of fungi_odb10
```
busco -i genome.fa -c 20 -o busco -m geno -l fungi_obd10 --offline
```
#run a circle to identify the busco genes of all genomes

## Step 2: sample and busco gene filtering
#data preparation Instructions
#1. Place BUSCO result files for each sample in the current directory
#2. Name sample forder using genome accession numbers (e.g., GCA_000000001.1)
#3. Execute extract_busco.sh to extract 'full_table_tsv' files from each sample folder
#extract_busco.sh

```
#!/bin/bash

# define the path
base_dir="/data/CMTG_genome_project/tree/"

# create an temperary directory
temp_dir=$(mktemp -d)
cd "$temp_dir"

# judge if the first file
first_file=1

# Go through each sample's folder
for dir in "$base_dir"/*/; do
  # extract sample name
  sample_name=$(basename "$dir")
  
  # define target path
  target_file="$dir/run_fungi_odb10/full_table.tsv"
  
  # check wether the target file exists
  if [ ! -f "$target_file" ]; then
    echo "warning: file $target_file doesn't exisit, skip it"
    continue
  fi
  
    filtered_content=$(grep -v '^#' "$target_file")
  
  # Extract the first two columns and uniq
  if [ $first_file -eq 1 ]; then
        echo -e "busco\t$sample_name" > "${sample_name}.col"
    echo "$filtered_content" | awk '{print $1 "\t" $2}' | sort -u -k1,1 | awk '{print $1 "\t" $2}' >> "${sample_name}.col"
    first_file=0
  else
       echo -e "$sample_name" > "${sample_name}.col"
    echo "$filtered_content" | awk '{print $1 "\t" $2}' | sort -u -k1,1 | awk '{print $2}' >> "${sample_name}.col"
  fi
done
```

#merge all columns
```
paste *.col > "$base_dir/combined_busco.tsv"

rm -rf "$temp_dir"

echo "Done! results have been saved in $base_dir/combined_busco.tsv"
```


# Calculate gene occurrence rates across all samples: For each BUSCO gene, determine its persence/absence proportion in the combined_busco.tsv
# encode BUSCO statuses: covert status values to binary format: Complete/Duplicated to 1 (present), Fragmented/missing to 0 (absent)
# usually retain genes with <5% missing data (i.e., present in at least 95% of samples). When calculate the missing data, outgroup taxa are not included.
# Exclude samples with BUSCO completeness substantially lower than closely related taxa  (likely indicating poor assembly auality)
# Export final gene set (single_busco.ID) for phylogenomic analysis

## Step 3  fasta file for tree construction
#run_alignment.sh
```
#!/bin/bash
base_path="/data/CMTG_genome_project/tree"
busco_ids_file="single_busco.ID"
#check if Single_busco.ID exists
if \[\[ ! -f "`$base_path/$`busco\_ids\_file" ]]; then
echo "Error: `$base_path/$`busco\_ids\_file does not exist."
exit 1
fi

while read -r busco_id; do 
output_file="$busco_id.faa"

> "$output_file"

# go through all sample folders in base_path
for sample_path in "$base_path"/*; do
    [[ -d "$sample_path" ]] || continue

       sample_id=$(basename "$sample_path")
               target_file="$sample_id/run_fungi_odb10/busco_sequences/single_copy_busco_sequences/$busco_id.faa"

               if [[ -f "$target_file" ]]; then
           sed "s/^>.*/>$sample_id/" "$target_file" >> "$output_file" 
        else
            # if absent fill gaps
            echo ">$sample_id" >> "$output_file"
        fi
 done

echo "Processed $busco_id. Output written to $output_file"
```

# Apply mafft to align every faa file and output files include buscoID.aligned.fasta buscoID.trimed.fasta buscoID.trimed.phylip

```
#!/bin/bash
while read line
do
if [[ {line}.faa
mafft --auto --thread 50 --quiet {line}.aligned.fasta
/data/Liangjunmin/opt/biosoft/trimal/source/trimal -in {line}.trimed.fasta -gappyout
#/data/Liangjunmin/opt/biosoft/trimal/source/trimal -in {line}.trimed.fasta -gt 0.8 -st 0.001 -cons 80
#python fasta_to_phylip.py {line}.trimed.auto.phylip
python fasta_to_phylip.py {line}.trimed.phylip
#seqkit seq {line}.aligned.fasta
done<single_busco.ID
```

# merge alligned phylip file of every busco ID and the absent gene loci are filled by gaps
# merge_phylip.sh

```
#!/usr/bin/env python3
import os

def merge_phylip_files(base_path, sample_list, output_file):
    # read sample list and keep the original orde
    with open(sample_list) as f:
        seen_lines = f.readlines()
    all_samples = list(dict.fromkeys(ln.strip() for ln in seen_lines if ln.strip()))
    expected_cnt = len(all_samples)     

    # collect all phylip files and merge
    files = [f for f in os.listdir(base_path) if f.endswith('.phylip')]
    if not files:
        print("Error: can not find any .phylip file")
        return

    # Initialization container
    seqs = {s: [] for s in all_samples}
    gene_lengths = []
    seen_samples = set()     

    # treat files one by one
    for fname in files:
        fpath = os.path.join(base_path, fname)
        with open(fpath) as f:
            head = f.readline().strip().split()
            nseq, L = int(head[0]), int(head[1])
            gene_lengths.append(L)

            present = {}
            for _ in range(nseq):
                line = f.readline().rstrip('\n')
                if len(line) < 30:
                    line += ' ' * (30 - len(line))
                sid = line[:30].rstrip()
                present[sid] = line[30:].strip()
                seen_samples.add(sid)

            for s in all_samples:
                seqs[s].append(present.get(s, '-' * L))

       # double check
    set_expect = set(all_samples)          
    set_actual = seen_samples             

    missing   = [s for s in all_samples if s not in set_actual]   # sample list includes but absent the corresponding phylip file
    redundant = [s for s in set_actual if s not in set_expect]    # sample list doesn't include but present the corresponding phylip file

    if missing or redundant:
        if missing:
            print(f"Warning: exisit in the sample list but phylip files misse")
            print('\n'.join(missing))
        if redundant:
            print(f"Warning: exist in phylip file but not in sample list {len(redundant)} ")
            print('\n'.join(redundant))
    else:
        print("sample list and phylip files are consistent")
    # Outputs
    total_length = sum(gene_lengths)
    with open(output_file, 'w') as out:
        out.write(f"{len(all_samples)} {total_length}\n")
        for s in all_samples:
            full_seq = ''.join(seqs[s])
            out.write(f"{s.ljust(30)}{full_seq}\n")

    print(f"Merged！output file：{output_file}")
    print(f"sample count：{len(all_samples)}，total length：{total_length}")

# ---------------- 调用 ----------------
base_path   = '/data/CMTG_genome_project/tree'
sample_list = '/data/CMTG_genome_project/tree/sample_list.txt'
output_file = 'merged_sequences.phylip'
merge_phylip_files(base_path, sample_list, output_file)
```

## Step 4 Running IQtree

```
iqtree -s merged_sequences.phylip -m MFP -bb 1000 -bnni --seqtype AA -pre fungi_genome -T AUTO --threads-max 128 --safe --quiet
```

